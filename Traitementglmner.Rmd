# Generalized linear mixed effects regression

import des libraries
```{r}
library(lme4)
library(dplyr)
library(readxl)
library(stringr)
library(tidyr)
```

import des données
```{r}
df <- read_excel("Data_salive_steroides_cinetique.xlsx")
head(df)
```
On passe en format long pour donner le temps de la journée au modèle. On va d'abord se concentrer sur un seul stéroide pour commencer, ici 17OHP.
```{r}
df <- df %>%
  pivot_longer(
    cols = c(`8h_17OHP`, `12h_17OHP`, `16h_17OHP`, `20h_17OHP`),
    names_to = "Time",
    values_to = "steroid_17OHP"
  ) %>%
  mutate(
    # Nettoyer l'heure pour avoir un truc propre
    Time = factor(Time,
                  levels = c("8h_17OHP", "12h_17OHP", "16h_17OHP", "20h_17OHP"),
                  labels = c("8", "12", "16", "20")),
    Groupe_bin = ifelse(Groupe == "Gp non contrôlé", 1, 0),
    Groupe_bin = factor(Groupe_bin),
    Gender = factor(Gender),
    `Puberty stage` = factor(`Puberty stage`),
    Patient_number = factor(`Patient number`)
  )
```

On enlève l'instabilité (on a pas assez de donnée et les données sont trop disperses sur Puberté, donc on coupe en 2 cas pour + de stabilité)
```{r}
df <- df %>%
  mutate(
    Puberty_stage_simple = case_when(
      `Puberty stage` %in% c(1, 2) ~ "prepubertal",
      TRUE ~ "pubertal"
    ),
    Puberty_stage_simple = factor(Puberty_stage_simple)
  )
```
Comme on s'intérèsse que au 17OHP pour l'instant, on garde que ce qui nous intéresse:
```{r}
df_d<- df %>%
  select(Patient_number, Gender, Puberty_stage_simple,
         Time, steroid_17OHP, Groupe_bin)
```

On va maintenant lancer le modèle.
```{r}
mod_17ohp <- glmer(
  Groupe_bin ~ log(steroid_17OHP + 1e-6) +
    Gender  + Puberty_stage_simple+
    (1 | Patient_number),
  data = df_d,
  family = binomial,
  control = glmerControl(optimizer = "bobyqa")
)
summary(mod_17ohp)
```
On voit que le steroid a un effet très significatif pour prédire le groupe. Gender importe aussi même si beaucoup moins que 17OHP.
```{r}
ranef(mod_17ohp)
```
```{r}
df_model <- model.frame(mod_17ohp)# uniquement les lignes complètes

df_model$steroid_17OHP <- model.frame(mod_17ohp)[[ "log(steroid_17OHP + 1e-06)" ]]
df_model$fitted <- fitted(mod_17ohp)
df_model$prob <- fitted(mod_17ohp)

df_model <- df_model[order(df_model$steroid_17OHP), ]
# Plot
library(ggplot2)
ggplot(df_model, aes(x = steroid_17OHP, y = prob)) +
  geom_point(aes(y = as.numeric(Groupe_bin)-1), alpha = 0.2) +
  geom_smooth(method = "loess", se = FALSE, color = "red", span = 0.8)

```

